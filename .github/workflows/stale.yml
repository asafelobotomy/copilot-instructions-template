name: Close stale issues and PRs

on:
  schedule:
    - cron: '0 8 * * 1'  # every Monday 08:00 UTC
  workflow_dispatch:

env:
  DAYS_STALE: 30   # days of inactivity before the stale label is applied
  DAYS_CLOSE: 7    # additional days before the item is closed
  DAYS_TOTAL: 37   # DAYS_STALE + DAYS_CLOSE (used in close messages)

jobs:
  stale:
    name: Stale triage
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/stale@b5d41d4e1d5dceea10e7104786b73624c18a190f # v10
        with:
          exempt-draft-pr: true
          stale-issue-message: >
            This issue has had no activity for ${{ env.DAYS_STALE }} days and will be closed in ${{ env.DAYS_CLOSE }} days
            unless someone comments or removes the `stale` label. If it's still
            relevant, please leave a comment â€” happy to reopen.
          close-issue-message: >
            Closed after ${{ env.DAYS_TOTAL }} days of inactivity. Please reopen if still relevant.
          stale-issue-label: stale
          exempt-issue-labels: 'pinned,security,roadmap,help wanted'

          stale-pr-message: >
            This PR has had no activity for ${{ env.DAYS_STALE }} days and will be closed in ${{ env.DAYS_CLOSE }} days
            unless there is new activity or the `stale` label is removed.
          close-pr-message: >
            Closed after ${{ env.DAYS_TOTAL }} days of inactivity. Please reopen to continue.
          stale-pr-label: stale
          exempt-pr-labels: 'pinned,security,do-not-merge'

          days-before-stale: ${{ env.DAYS_STALE }}
          days-before-close: ${{ env.DAYS_CLOSE }}
