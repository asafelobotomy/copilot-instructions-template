name: CI — Validate template

on:
  push:
    branches: [main]
  pull_request:

jobs:
  validate:
    name: Structural validation
    runs-on: ubuntu-latest
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: VERSION is valid semver
        run: |
          V=$(tr -d '[:space:]' < VERSION)
          echo "VERSION: $V"
          echo "$V" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$' \
            || { echo "❌ Not a valid semver (expected x.y.z)"; exit 1; }
          echo "✅ OK"

      - name: CHANGELOG has [Unreleased] section
        run: |
          grep -q '## \[Unreleased\]' CHANGELOG.md \
            || { echo "❌ Missing ## [Unreleased] in CHANGELOG.md"; exit 1; }
          echo "✅ OK"

      - name: CHANGELOG has entry for current VERSION
        run: |
          V=$(tr -d '[:space:]' < VERSION)
          grep -q "## \[$V\]" CHANGELOG.md \
            || { echo "❌ CHANGELOG.md missing entry for [$V] — add one before bumping VERSION"; exit 1; }
          echo "✅ OK"

      - name: All required template files present
        run: |
          missing=0
          for f in \
            ".github/copilot-instructions.md" \
            ".github/agents/setup.agent.md" \
            ".github/agents/coding.agent.md" \
            ".github/agents/review.agent.md" \
            ".github/agents/fast.agent.md" \
            "SETUP.md" "UPDATE.md" "AGENTS.md" "VERSION" "CHANGELOG.md" \
            "LICENSE" "CONTRIBUTING.md" \
            "docs/INSTRUCTIONS-GUIDE.md" "docs/SETUP-GUIDE.md" \
            "docs/UPDATE-GUIDE.md" "docs/AGENTS-GUIDE.md" \
            "docs/EXTENSION-REVIEW-GUIDE.md" \
            "docs/TEST-REVIEW-GUIDE.md" \
            "docs/SKILLS-GUIDE.md" \
            "docs/PATH-INSTRUCTIONS-GUIDE.md" \
            "docs/PROMPTS-GUIDE.md" \
            "docs/SECURITY-GUIDE.md" \
            "docs/MCP-GUIDE.md" \
            "docs/RELEASE-AUTOMATION-GUIDE.md" \
            "template/copilot-setup-steps.yml" \
            "template/vscode/mcp.json" \
            "template/CHANGELOG.md" "template/JOURNAL.md" \
            "template/BIBLIOGRAPHY.md" "template/METRICS.md" \
            "template/workspace/IDENTITY.md" "template/workspace/SOUL.md" \
            "template/workspace/USER.md" "template/workspace/TOOLS.md" \
            "template/workspace/MEMORY.md" "template/workspace/BOOTSTRAP.md"; do
            if [[ ! -f "$f" ]]; then
              echo "❌ Missing: $f"; missing=1
            fi
          done
          [[ $missing -eq 0 ]] || exit 1
          echo "✅ All required files present"

      - name: copilot-instructions.md has all sections §1–§13
        run: |
          missing=0
          for s in "§1" "§2" "§3" "§4" "§5" "§6" "§7" "§8" "§9" "§10" "§11" "§12" "§13"; do
            grep -q "$s" .github/copilot-instructions.md \
              || { echo "❌ Missing $s"; missing=1; }
          done
          [[ $missing -eq 0 ]] || exit 1
          echo "✅ All sections §1–§13 present"

      - name: Template skills have valid SKILL.md
        run: |
          failed=0
          for skill_dir in template/skills/*/; do
            skill="$skill_dir/SKILL.md"
            if [[ ! -f "$skill" ]]; then
              echo "❌ Missing SKILL.md in $skill_dir"; failed=1; continue
            fi
            grep -q '^name:' "$skill" \
              || { echo "❌ $skill missing 'name' field"; failed=1; }
            grep -q '^description:' "$skill" \
              || { echo "❌ $skill missing 'description' field"; failed=1; }
          done
          [[ $failed -eq 0 ]] || exit 1
          echo "✅ All template skills valid"

      - name: Template skills have recommended fields (advisory)
        run: |
          warned=0
          for skill_dir in template/skills/*/; do
            skill="$skill_dir/SKILL.md"
            [[ -f "$skill" ]] || continue
            grep -q '^compatibility:' "$skill" \
              || { echo "⚠️  $skill missing optional 'compatibility' field"; warned=1; }
            grep -q '^allowed-tools:' "$skill" \
              || { echo "⚠️  $skill missing optional 'allowed-tools' field"; warned=1; }
          done
          if [[ $warned -eq 1 ]]; then
            echo "ℹ️  Some skills are missing optional fields — consider adding them"
          fi
          echo "✅ Advisory check complete (non-blocking)"

      - name: README docs-table links resolve to real files
        run: |
          failed=0
          while IFS= read -r link; do
            [[ -f "$link" ]] || { echo "❌ README links to missing file: $link"; failed=1; }
          done < <(grep -oP '\(docs/[^)]+\)' README.md | tr -d '()')
          [[ $failed -eq 0 ]] || exit 1
          echo "✅ All README docs links resolve"

      - name: No merge-conflict markers
        run: |
          if grep -rn '^<<<<<<< \|^>>>>>>> \|^=======$' --include='*.md' .; then
            echo "❌ Merge conflict markers found"; exit 1
          fi
          echo "✅ Clean"

      - name: Template placeholders present in copilot-instructions.md
        run: |
          count=$(grep -c '{{' .github/copilot-instructions.md 2>/dev/null || echo 0)
          if [[ "$count" -lt 3 ]]; then
            echo "❌ Only $count {{PLACEHOLDER}} tokens found — template may have been resolved upstream"
            exit 1
          fi
          echo "✅ $count placeholder tokens present"

  markdownlint:
    name: Markdown lint
    runs-on: ubuntu-latest
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: DavidAnson/markdownlint-cli2-action@07035fd053f7be764496c0f8d8f9f41f98305101 # v22
        with:
          globs: |
            **/*.md
            !template/**
            !examples/**
            !node_modules/**

  actionlint:
    name: Workflow lint
    runs-on: ubuntu-latest
    steps:
      - name: Harden runner
        uses: step-security/harden-runner@5ef0c079ce82195b2a36a210272d6b661572d83e # v2
        with:
          egress-policy: audit

      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: raven-actions/actionlint@e01d1ea33dd6a5ed517d95b4c0c357560ac6f518 # v2
